<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survev Player Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; animation: slideDown 0.8s ease; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo-section img { width: 35px; height: 35px; }
        
        .search-bar { display: flex; gap: 8px; background: var(--card); padding: 12px; border-radius: 10px; }
        select, input, button { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; }
        button { background: var(--accent); color: #0f172a; font-weight: bold; border: none; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: var(--card); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid var(--accent); animation: fadeIn 1s ease; }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }

        #dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .server-card { background: var(--card); padding: 25px; border-radius: 15px; text-align: center; animation: slideUp 0.6s ease both; }
        .player-count { font-size: 3rem; font-weight: 800; color: var(--accent); }

        .graph-container { background: var(--card); padding: 25px; border-radius: 15px; margin-top: 20px; animation: fadeIn 1.2s ease; }
        .graph-controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }

        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="logo-section">
            <img src="https://survev.io/favicon.ico" alt="Logo">
            <h1>Survev Player Tracker</h1>
        </div>
        <div class="search-bar">
            <select id="search-server">
                <option value="North America">North America</option>
                <option value="South America">South America</option>
                <option value="Europe">Europe</option>
                <option value="Asia">Asia</option>
                <option value="Russia">Russia</option>
            </select>
            <input type="datetime-local" id="search-time">
            <button onclick="searchHistory()">Search Old Records</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-box"><div class="stat-label">Most Popular Server</div><div id="top-server" class="stat-value">Loading...</div></div>
        <div class="stat-box"><div class="stat-label">Least Popular Server</div><div id="bottom-server" class="stat-value">Loading...</div></div>
        <div class="stat-box"><div class="stat-label">Peak Activity Time</div><div id="peak-time" class="stat-value">Loading...</div></div>
        <div class="stat-box"><div class="stat-label">Last Updated</div><div id="last-updated" class="stat-value">---</div></div>
    </div>

    <div id="search-result" style="display:none; background:var(--accent); color:black; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center; font-weight:bold;"></div>

    <div id="dashboard"></div>

    <div class="graph-container">
        <div class="graph-controls">
            <select id="graph-server" onchange="updateGraph()">
                <option value="North America">North America</option>
                <option value="Europe">Europe</option>
                <option value="Asia">Asia</option>
                <option value="Russia">Russia</option>
                <option value="South America">South America</option>
            </select>
            <input type="date" id="graph-date-start" onchange="updateGraph()">
            <input type="date" id="graph-date-end" onchange="updateGraph()">
        </div>
        <canvas id="playerChart" height="100"></canvas>
    </div>

    <script>
        const oldUrl = "https://raw.githubusercontent.com/karizzmaa/Survev-Player-Tracker/main/old.csv";
        const latestUrl = "https://raw.githubusercontent.com/karizzmaa/Survev-Player-Tracker/main/latest.csv";
        let chartInstance = null;
        let allHistoryData = [];

        async function init() {
            fetchUpdateStatus();
            loadLatest();
            loadHistoryAndStats();
        }

        async function fetchUpdateStatus() {
            try {
                const res = await fetch(`https://api.github.com/repos/karizzmaa/Survev-Player-Tracker/commits/main`);
                const data = await res.json();
                const diff = Math.floor((new Date() - new Date(data.commit.author.date)) / 60000);
                document.getElementById('last-updated').innerText = `${diff}m ago`;
            } catch(e) { document.getElementById('last-updated').innerText = "Just now"; }
        }

        function loadLatest() {
            Papa.parse(latestUrl, { download: true, header: true, complete: (results) => {
                const container = document.getElementById('dashboard');
                results.data.forEach((row, i) => {
                    if(!row.Server) return;
                    const card = document.createElement('div');
                    card.className = 'server-card';
                    card.style.animationDelay = `${i * 0.1}s`;
                    card.innerHTML = `<div class="stat-label">${row.Server}</div><div class="player-count" id="c-${i}">0</div><div>Players</div>`;
                    container.appendChild(card);
                    animateCount(document.getElementById(`c-${i}`), parseInt(row.Players));
                });
            }});
        }

        function animateCount(obj, end) {
            let start = 0;
            let duration = 1500;
            let startTimestamp = null;
            const step = (ts) => {
                if (!startTimestamp) startTimestamp = ts;
                const prog = Math.min((ts - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(prog * end);
                if (prog < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function loadHistoryAndStats() {
            Papa.parse(oldUrl, { download: true, header: false, complete: (results) => {
                allHistoryData = results.data.filter(r => r.length >= 3 && !r[1].includes("Server"));
                calculateStats();
                updateGraph();
            }});
        }

        function calculateStats() {
            const serverTotals = {};
            const timeTotals = {};
            
            allHistoryData.forEach(r => {
                const server = r[1], count = parseInt(r[2]), time = r[0].split(' ')[1]?.split(':')[0];
                if(server) serverTotals[server] = (serverTotals[server] || 0) + count;
                if(time) timeTotals[time] = (timeTotals[time] || 0) + count;
            });

            const sortedServers = Object.entries(serverTotals).sort((a,b) => b[1] - a[1]);
            document.getElementById('top-server').innerText = sortedServers[0]?.[0] || "---";
            document.getElementById('bottom-server').innerText = sortedServers[sortedServers.length-1]?.[0] || "---";
            
            const peakHour = Object.entries(timeTotals).sort((a,b) => b[1] - a[1])[0]?.[0];
            document.getElementById('peak-time').innerText = peakHour ? `${peakHour}:00` : "---";
        }

        function updateGraph() {
            const server = document.getElementById('graph-server').value;
            const start = document.getElementById('graph-date-start').value;
            const end = document.getElementById('graph-date-end').value;

            let filtered = allHistoryData.filter(r => r[1] === server);
            if(start) filtered = filtered.filter(r => r[0] >= start);
            if(end) filtered = filtered.filter(r => r[0] <= end + " 23:59:59");

            const labels = filtered.map(r => r[0]);
            const values = filtered.map(r => parseInt(r[2]));

            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('playerChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: `${server} Player Trend`, data: values, borderColor: '#38bdf8', tension: 0.3, fill: true, backgroundColor: 'rgba(56, 189, 248, 0.1)' }]},
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#334155' } }, x: { grid: { display: false } } } }
            });
        }

        function searchHistory() {
            const srv = document.getElementById('search-server').value;
            const time = new Date(document.getElementById('search-time').value);
            const resBox = document.getElementById('search-result');
            if(isNaN(time)) return alert("Pick a time!");

            let best = null, minDiff = 7200000; // 2 hours
            allHistoryData.filter(r => r[1] === srv).forEach(r => {
                let d = Math.abs(time - new Date(r[0]));
                if(d < minDiff) { minDiff = d; best = r; }
            });

            resBox.style.display = "block";
            resBox.innerHTML = best ? `Result: ${best[1]} had ${best[2]} players at ${best[0]}` : "No data found within 2 hours of that time.";
        }

        init();
    </script>
</body>
</html>
